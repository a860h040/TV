<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STARTV — Sheet Player</title>
  <style>
    body{margin:0;background:#04050a;color:#f3f5ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:#e50914;border:0;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button:focus{outline:3px solid rgba(255,255,255,.35)}
    .muted{color:rgba(243,245,255,.65)}
    .panel{margin-top:14px;background:rgba(14,16,24,.62);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px}
    video{width:100%;max-height:62vh;background:black;border-radius:14px}
    ul{list-style:none;padding:0;margin:10px 0 0}
    li{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);margin:8px 0;background:rgba(0,0,0,.25)}
    li:focus{outline:3px solid rgba(255,255,255,.30)}
    .title{font-weight:800}
    .url{font-size:12px;word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px">STARTV — Sheet Player</h1>
    <div class="row">
      <button id="btnLatest">Play Latest</button>
      <button id="btnList">Load Recent</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="panel">
      <div class="muted" id="nowPlaying">Nothing playing.</div>
      <div style="height:10px"></div>
      <video id="v" controls playsinline></video>
    </div>

    <div class="panel">
      <div class="title">Recent links</div>
      <div class="muted" style="margin-top:6px">Use ↑/↓ then Enter to play (TV remote friendly).</div>
      <ul id="list"></ul>
    </div>
  </div>

<script>
  // ✅ paste your Apps Script /exec URL here
  const API = "https://script.google.com/macros/s/AKfycbxdl0itrBq4SL5icNezBPx_EoiMkAn6AC6PdkgaUf_ECLj_eshVCU9HH6QSHXkM0FU2/exec";

  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const listEl = $("list");
  const videoEl = $("v");
  const nowEl = $("nowPlaying");

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  // JSONP helper (avoids CORS issues)
  function jsonp(params){
    return new Promise((resolve,reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = API + "?" + new URLSearchParams({ ...params, callback: cb, _: Date.now() }).toString();
      const s = document.createElement("script");
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("JSONP failed")); };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        s.remove();
      }
      s.src = url;
      document.body.appendChild(s);
    });
  }

  function tryPlay(url){
    if(!url) return;

    nowEl.textContent = "Now playing: " + url;
    setStatus("");

    // VLC-style links (vlc://...) usually cannot be played by HTML5 video.
    // We will try: if it fails, we show a message.
    videoEl.pause();
    videoEl.removeAttribute("src");
    videoEl.load();

    videoEl.src = url;

    const p = videoEl.play();
    if (p && p.catch) {
      p.catch(()=>{
        setStatus("This device/browser can’t play this format/link. Try mp4/m3u8 or use a compatible player.");
      });
    }
  }

  function renderList(items){
    listEl.innerHTML = "";
    (items || []).forEach((it, idx)=>{
      const li = document.createElement("li");
      li.tabIndex = 0;
      li.dataset.url = it.url;
      li.innerHTML = `
        <div class="title">${escapeHtml(it.title || "(No title)")}</div>
        <div class="muted">${escapeHtml(it.ts || "")}</div>
        <div class="url muted">${escapeHtml(it.url || "")}</div>
      `;
      li.addEventListener("click", ()=> tryPlay(it.url));
      li.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === "OK"){ tryPlay(it.url); }
      });
      listEl.appendChild(li);
      if(idx === 0) li.focus();
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function playLatest(){
    setStatus("Loading latest…");
    const res = await jsonp({ action: "latest" });
    if(!res || !res.ok || !res.item || !res.item.url){
      setStatus("No links found in sheet yet.");
      return;
    }
    setStatus("Playing latest ✅");
    tryPlay(res.item.url);
  }

  async function loadRecent(){
    setStatus("Loading recent…");
    const res = await jsonp({ action: "list", limit: "25" });
    if(!res || !res.ok){
      setStatus("Failed to load list.");
      return;
    }
    setStatus("Loaded ✅");
    renderList(res.items || []);
  }

  $("btnLatest").onclick = playLatest;
  $("btnList").onclick = loadRecent;

  // Remote-friendly list navigation
  document.addEventListener("keydown", (e)=>{
    const active = document.activeElement;
    if(active && active.tagName === "LI"){
      if(e.key === "ArrowDown"){ e.preventDefault(); (active.nextElementSibling||active).focus(); }
      if(e.key === "ArrowUp"){ e.preventDefault(); (active.previousElementSibling||active).focus(); }
    }
    if(e.key === "Backspace" || e.key === "Escape"){
      // optional: go back to your main page
      // location.href = "index.html";
    }
  });

  // Auto-load recent on open
  loadRecent();
</script>
</body>
</html>
