<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STARTV Player</title>
  <style>
    :root{
      --bg:#000;
      --glass:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.18);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.68);
      --accent:#e50914;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,Segoe UI,Arial}
    .wrap{height:100%; display:grid; grid-template-rows:auto 1fr; }
    .top{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(0,0,0,.78), rgba(0,0,0,.20));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .btn{
      border:1px solid var(--stroke);
      background:var(--glass);
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      user-select:none;
    }
    .btn.primary{
      border:0;
      background:linear-gradient(135deg, var(--accent), #ff3340);
    }
    .title{
      min-width:0;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .hint{
      font-size:12px;
      color:var(--mut);
      white-space:nowrap;
    }

    .player{
      position:relative;
      height:100%;
      background:#000;
    }
    video{
      width:100%;
      height:100%;
      object-fit:contain;
      background:#000;
      outline:none;
    }

    .msg{
      position:fixed; left:12px; right:12px; bottom:12px;
      padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.14);
      font-size:14px; line-height:1.35;
      backdrop-filter: blur(10px);
    }
    a{color:#8ab4ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button class="btn" id="backBtn" title="Back">← Back</button>
      <div class="title" id="t">Loading…</div>
      <button class="btn" id="openBtn" title="Open link in new tab">Open</button>
      <button class="btn primary" id="retryBtn" title="Retry">Retry</button>
      <div class="hint">Remote: ←/→ seek • Enter play/pause • Back to return</div>
    </div>

    <div class="player">
      <video id="v" controls playsinline preload="auto"></video>
    </div>
  </div>

  <div class="msg" id="msg">Loading…</div>

  <!-- HLS.js for .m3u8 on browsers without native HLS (may require CORS headers) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- dash.js for .mpd (optional support; also requires CORS) -->
  <script src="https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js"></script>

  <script>
    const v = document.getElementById("v");
    const msg = document.getElementById("msg");
    const t = document.getElementById("t");
    const backBtn = document.getElementById("backBtn");
    const openBtn = document.getElementById("openBtn");
    const retryBtn = document.getElementById("retryBtn");

    function setMsg(html){ msg.innerHTML = html; }

    function readPayload(){
      const p = new URLSearchParams(location.search);
      let src = p.get("src") || "";
      let title = p.get("title") || "";
      let poster = p.get("poster") || "";

      // Fallback to sessionStorage (handles extra-long URLs)
      if (!src){
        try{
          const saved = JSON.parse(sessionStorage.getItem("STARTV_LAST_PLAY") || "null");
          if (saved && saved.url){
            src = saved.url || "";
            title = title || saved.title || "";
            poster = poster || saved.poster || "";
          }
        }catch{}
      }

      return { src, title, poster };
    }

    function guessType(url){
      const u = (url || "").toLowerCase();
      if (u.includes(".m3u8")) return "hls";
      if (u.includes(".mpd"))  return "dash";
      if (u.match(/\.(mp4|webm)(\?|$)/)) return "file";
      if (u.match(/\.(mkv)(\?|$)/)) return "mkv";
      return "file";
    }

    function maybeHttps(url){
      // GitHub Pages is HTTPS. If URL is http:// many browsers block it.
      if (location.protocol === "https:" && url.startsWith("http://")){
        return { tryUrl: url.replace(/^http:\/\//i, "https://"), original: url, swapped: true };
      }
      return { tryUrl: url, original: url, swapped: false };
    }

    let hls = null;
    let dash = null;

    function cleanup(){
      try{
        if (hls){ hls.destroy(); hls = null; }
        if (dash){ dash.reset(); dash = null; }
      }catch{}
      try{ v.pause(); }catch{}
      try{ v.removeAttribute("src"); v.load(); }catch{}
    }

    async function playUrl(rawUrl, title, poster){
      cleanup();

      t.textContent = title || "STARTV Player";
      if (poster) v.setAttribute("poster", poster); else v.removeAttribute("poster");

      if (!rawUrl){
        setMsg("No video URL received. Go back and select a title again.");
        return;
      }

      const { tryUrl, original, swapped } = maybeHttps(rawUrl);
      const type = guessType(tryUrl);

      openBtn.onclick = ()=> window.open(original, "_blank", "noopener");
      retryBtn.onclick = ()=> playUrl(rawUrl, title, poster);
      backBtn.onclick  = ()=> (history.length > 1 ? history.back() : (location.href = "./"));

      if (swapped){
        setMsg(
          `This site is <b>HTTPS</b> (GitHub Pages). Your link is <b>HTTP</b>, which is often blocked.<br>
           I will try <b>HTTPS</b> automatically.<br>
           Original: <a href="${original}" target="_blank" rel="noopener">open http link</a>`
        );
      } else {
        setMsg(`Opening… <a href="${original}" target="_blank" rel="noopener">Open link</a>`);
      }

      // MKV warning (many browsers/TVs won't play mkv in HTML5 video)
      if (type === "mkv"){
        setMsg(
          `This looks like an <b>MKV</b> file. Many browsers/TV players can’t play MKV directly.<br>
           Try the <b>Open</b> button (external player) or use an MP4/HLS link.`
        );
        // Still try (some TVs can)
      }

      // HLS
      if (type === "hls"){
        const canNative = v.canPlayType("application/vnd.apple.mpegurl");
        if (canNative){
          v.src = tryUrl;
        } else if (window.Hls && Hls.isSupported()){
          hls = new Hls({
            // NOTE: hls.js needs CORS headers from the server because it fetches segments via XHR.
            // If your server doesn't send Access-Control-Allow-Origin, playback may fail.
          });
          hls.loadSource(tryUrl);
          hls.attachMedia(v);
          hls.on(Hls.Events.ERROR, function(_, data){
            setMsg(
              `HLS error. This often means the server blocks CORS for playlist/segments.<br>
               Try <b>Open</b> (external) or use a different stream URL.<br>
               <small>${data && data.details ? data.details : ""}</small>`
            );
          });
        } else {
          setMsg("This browser/TV cannot play HLS (.m3u8) here. Try Open (external).");
          return;
        }
      }

      // DASH
      else if (type === "dash"){
        if (window.dashjs){
          dash = dashjs.MediaPlayer().create();
          dash.initialize(v, tryUrl, true);
          dash.on("error", function(){
            setMsg(
              `DASH error. This often means the server blocks CORS for segments.<br>
               Try <b>Open</b> (external) or use a different stream URL.`
            );
          });
        } else {
          setMsg("DASH player not available. Try Open (external).");
          return;
        }
      }

      // Regular file (mp4, webm, etc)
      else {
        v.src = tryUrl;
      }

      // Try autoplay (many TVs block autoplay unless muted)
      try{
        await v.play();
        setMsg("Playing ✅");
      }catch(e){
        setMsg("Press Play (autoplay may be blocked on this device).");
      }
    }

    // Remote-friendly controls
    document.addEventListener("keydown", (e)=>{
      const key = e.key;
      const code = e.keyCode || e.which;

      const isBack =
        key === "Escape" || key === "Backspace" || key === "BrowserBack" || key === "GoBack" ||
        code === 27 || code === 8 || code === 461 || code === 10009;

      if (isBack){
        e.preventDefault(); e.stopPropagation();
        backBtn.click();
        return;
      }

      // Enter toggles play/pause
      if (key === "Enter" || code === 13){
        e.preventDefault(); e.stopPropagation();
        if (v.paused) v.play().catch(()=>{});
        else v.pause();
        return;
      }

      const seek = (sec)=>{
        try{
          const t = Math.max(0, Math.min((v.duration || Infinity), (v.currentTime || 0) + sec));
          v.currentTime = t;
        }catch{}
      };

      if (key === "ArrowLeft" || code === 37){ e.preventDefault(); seek(-10); return; }
      if (key === "ArrowRight"|| code === 39){ e.preventDefault(); seek( 10); return; }
      if (key === "ArrowUp"   || code === 38){ e.preventDefault(); try{ v.volume = Math.min(1, (v.volume||0) + 0.08); }catch{} return; }
      if (key === "ArrowDown" || code === 40){ e.preventDefault(); try{ v.volume = Math.max(0, (v.volume||0) - 0.08); }catch{} return; }
    });

    // Errors
    v.addEventListener("error", ()=>{
      const e = v.error;
      setMsg(
        `Playback error.${e ? (" Code: " + e.code) : ""}<br>
         Try <b>Open</b> (external) or your server may not support HTTPS/CORS.<br>`
      );
    });

    // Boot
    const payload = readPayload();
    playUrl(payload.src, payload.title, payload.poster);
  </script>
</body>
</html>


