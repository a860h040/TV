<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IPTV — Stream UI (Hero + Rows)</title>

<style>
  :root{
    --bg:#07090f;
    --panel:rgba(14,18,28,.72);
    --panelSolid:#0e121c;
    --text:#eef2ff;
    --muted:#a8b0c4;
    --accent:#7c3aed;
    --accent2:#22c55e;
    --border:rgba(255,255,255,.10);
    --shadow:0 18px 60px rgba(0,0,0,.55);
    --radius:18px;
    --radiusSm:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 800px at 70% -10%, rgba(124,58,237,.20), transparent 55%),
                radial-gradient(900px 700px at 20% 10%, rgba(34,197,94,.10), transparent 55%),
                var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    overflow-x:hidden;
  }

  /* ===== Top Bar ===== */
  header{
    position:fixed;
    top:0; left:0; right:0;
    z-index:100;
    transition: background .25s ease, border-color .25s ease, backdrop-filter .25s ease;
    background:transparent;
    border-bottom:1px solid transparent;
    backdrop-filter: blur(10px);
  }
  header.solid{
    background:rgba(14,18,28,.82);
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .topbar{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 14px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-weight:900;
    letter-spacing:.3px;
    white-space:nowrap;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background:linear-gradient(135deg,var(--accent), #a78bfa);
    box-shadow:0 0 0 6px rgba(124,58,237,.14);
  }
  .brand span{opacity:.95}
  .spacer{flex:1}

  .pill{
    display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    border-radius:999px;
    padding:8px 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  input{
    border:0;
    outline:none;
    background:transparent;
    color:var(--text);
    min-width:140px;
    font-size:.95rem;
  }
  input::placeholder{color:rgba(238,242,255,.55)}
  button{
    border:0;
    border-radius:999px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:900;
    color:var(--text);
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.12);
    transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
  }
  button:hover{transform:translateY(-1px); background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18)}
  button:active{transform:translateY(0px) scale(.99)}
  button.primary{
    background:linear-gradient(135deg, var(--accent), #a78bfa);
    border:0;
    box-shadow:0 12px 30px rgba(124,58,237,.28);
  }
  button.primary:hover{filter:brightness(1.05)}
  button.ghost{background:rgba(255,255,255,.05)}
  button:disabled{opacity:.45; cursor:not-allowed}

  #status{
    margin-left:10px;
    font-size:.86rem;
    color:var(--muted);
    white-space:nowrap;
  }
  .statusPill{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
  }
  .ok{color:#22c55e}
  .err{color:#ef4444}
  .warn{color:#fbbf24}

  /* ===== Search slide-down ===== */
  #searchWrap{
    overflow:hidden;
    max-height:0;
    transition:max-height .25s ease, transform .25s ease, padding .25s ease;
    transform: translateY(-6px);
    padding:0 14px;
    border-top:1px solid rgba(255,255,255,.06);
  }
  /* ===== Search slide-down (bigger dropdown) ===== */
#searchWrap.open{
  /* was: max-height:120px; */
  max-height: min(60vh, 520px);   /* taller dropdown */
  padding:10px 14px 14px 14px;
  transform: translateY(0);
}
  .searchBar{
    width:min(980px, 100%);
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    padding:12px 14px;
    display:flex; gap:10px; align-items:center;
  }
  .searchBar input{min-width:0; flex:1}
  .kbd{
    font-size:.78rem;
    color:rgba(238,242,255,.65);
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:10px;
    padding:4px 8px;
  }
 #searchResults{
  margin-top:10px;
  display:none;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  border-radius:var(--radius);
  overflow:auto;                  /* was: hidden */
  max-height: calc(min(60vh, 520px) - 70px); /* room for the search input */
}
  #searchResults.show{display:block}
  .resItem{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-top:1px solid rgba(255,255,255,.06);
    cursor:pointer;
  }
  #searchResults::-webkit-scrollbar{ width:10px }
#searchResults::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.16); border-radius:999px }
#searchResults::-webkit-scrollbar-track{ background:transparent }
}
  .resItem:first-child{border-top:0}
  .resItem:hover{background:rgba(255,255,255,.06)}
  .resThumb{
    width:38px; height:52px; border-radius:10px; object-fit:cover;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
  }
  .resText{min-width:0}
  .resName{font-weight:900; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .resMeta{color:var(--muted); font-size:.82rem}

  /* ===== Hero ===== */
  .hero{
    position:relative;
    min-height:64vh;
    padding-top:82px;
    display:flex;
    align-items:flex-end;
  }
  .heroBg{
    position:absolute; inset:0;
    background:
      linear-gradient(90deg, rgba(7,9,15,.92) 0%, rgba(7,9,15,.55) 45%, rgba(7,9,15,.20) 75%, rgba(7,9,15,.92) 100%),
      linear-gradient(0deg, rgba(7,9,15,.98) 0%, rgba(7,9,15,.55) 28%, rgba(7,9,15,.15) 60%, rgba(7,9,15,.92) 100%),
      url('https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=1800&q=60');
    background-size:cover;
    background-position:center;
    filter:saturate(1.05) contrast(1.05);
  }
  .heroInner{
    position:relative;
    width:min(1200px, 92vw);
    margin:0 auto;
    padding:28px 0 26px 0;
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:22px;
    align-items:end;
  }
  .heroCard{max-width:720px}
  .heroTitle{
    font-size: clamp(2rem, 4vw, 3.25rem);
    font-weight:1000;
    line-height:1.02;
    margin:0 0 10px 0;
    letter-spacing:-.6px;
  }
  .heroDesc{
    margin:0;
    color:rgba(238,242,255,.80);
    font-size:1.02rem;
    line-height:1.55;
    max-width:62ch;
  }
  .heroMeta{
    margin-top:10px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    color:rgba(238,242,255,.72);
    font-size:.9rem;
  }
  .tag{
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
  }
  .heroActions{
    margin-top:16px;
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .heroRight{display:flex; justify-content:flex-end}
  .heroPoster{
    width:min(340px, 52vw);
    aspect-ratio: 2/3;
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
    background:rgba(255,255,255,.06);
  }
  .heroPoster img{width:100%; height:100%; object-fit:cover; filter:saturate(1.05)}

  /* ===== Browse page ===== */
  #browsePage{display:block}
  .content{
    width:min(1200px, 92vw);
    margin:0 auto;
    padding:18px 0 60px 0;
  }
  .sectionHead{
    display:flex; align-items:end; justify-content:space-between; gap:12px;
    margin:16px 0 10px;
  }
  .sectionTitle{
    margin:0;
    font-size:1.25rem;
    font-weight:1000;
    letter-spacing:.1px;
  }
  .sectionSub{color:var(--muted); font-size:.86rem}

  .row{
    position:relative;
    display:flex;
    gap:12px;
    overflow:auto;
    padding:6px 2px 12px;
    scroll-snap-type:x mandatory;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,.25) transparent;
  }
  .row::-webkit-scrollbar{height:10px}
  .row::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:999px}
  .row::-webkit-scrollbar-track{background:transparent}

  /* ===== Card base ===== */
  .card{
    flex:0 0 auto;
    width:160px;
    border-radius:18px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
    cursor:pointer;
    scroll-snap-align:start;
    transition: transform .14s ease, border-color .14s ease, background .14s ease;
    position:relative;
  }
  .card:hover{
    transform: translateY(-3px) scale(1.02);
    border-color: rgba(167,139,250,.35);
    background:rgba(255,255,255,.07);
  }
  .poster{
    width:100%;
    height:220px;
    object-fit:cover;
    display:block;
    background:rgba(255,255,255,.05);
  }
  .cardInfo{padding:10px 10px 12px}
  .name{
    font-weight:950;
    font-size:.95rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .meta{
    margin-top:4px;
    color:rgba(238,242,255,.70);
    font-size:.82rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .favBtn{
    position:absolute; top:10px; right:10px;
    width:34px; height:34px;
    border-radius:999px;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.14);
    display:flex; align-items:center; justify-content:center;
    font-weight:1000;
  }
  .favBtn.on{color:#ffd166}
  .favBtn.off{color:rgba(238,242,255,.70)}
  .skeleton{
    animation: pulse 1.1s ease-in-out infinite;
    background:rgba(255,255,255,.06);
  }
  @keyframes pulse{0%,100%{opacity:.65}50%{opacity:1}}

  /* ===== SEE ALL PAGE (new “different page”) ===== */
  #seeAllPage{
    display:none;
    padding-top:82px; /* fixed header spacing */
  }
  .seeAllWrap{
    width:min(1400px, 94vw);
    margin:0 auto;
    padding:16px 0 60px 0;
  }
  .seeAllHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin:8px 0 14px 0;
  }
  .seeAllTitle{
    margin:0;
    font-size:1.2rem;
    font-weight:1000;
    letter-spacing:.2px;
  }
  .seeAllSub{color:var(--muted); font-size:.86rem; margin-top:4px}
  .seeAllLeft{display:flex; flex-direction:column}

  /* 4 per row */
  .seeAllGrid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap:18px;
  }

  /* Image size “3' x 5'” -> enforce 3:5 aspect ratio */
  #seeAllPage .card{
    width:100%;
    border-radius:20px;
  }
  #seeAllPage .poster{
    height:auto;
    aspect-ratio: 3 / 5; /* 3 by 5 */
    object-fit:cover;
  }
  #seeAllPage .cardInfo{padding:12px 12px 14px}
  #seeAllPage .name{font-size:1rem}
  #seeAllPage .meta{font-size:.85rem}

  /* ===== Series Drawer ===== */
  #drawer{display:none;position:fixed;inset:auto 0 0 0;background:rgba(10,12,18,.92);border-top:1px solid rgba(255,255,255,.10);max-height:68vh;overflow:auto;z-index:250;backdrop-filter:blur(10px)}
  #drawerHead{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
  #drawer h3{margin:0;font-weight:1000}
  #drawerTools{display:flex;gap:8px;flex-wrap:wrap}
  .btn{
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:var(--text);
  }
  .btn.primary{background:linear-gradient(135deg, var(--accent), #a78bfa); border:0}
  #seasons{padding:12px 14px;display:grid;gap:10px}
  details{
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    overflow:hidden;
    background:rgba(255,255,255,.04);
  }
  summary{
    cursor:pointer;
    padding:12px 14px;
    font-weight:1000;
    background:rgba(255,255,255,.04);
  }
  .episodes{padding:10px 12px;display:grid;gap:10px}
  .ep{
    display:grid;
    grid-template-columns: 1fr auto auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.20);
  }
  .ep .epName{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:900}
  a.linkBtn{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    color:white;
    background:linear-gradient(135deg, var(--accent), #a78bfa);
  }

  /* Mobile */
  @media (max-width:980px){
    .seeAllGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
  }
  @media (max-width:760px){
    .heroInner{grid-template-columns:1fr; padding:22px 0 18px 0}
    .heroRight{justify-content:flex-start}
    .heroPoster{width:min(280px, 72vw)}
    input{min-width:120px}
    .card{width:145px}
    .poster{height:205px}
    .seeAllGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
  }
</style>
</head>

<body>

<header id="hdr">
  <div class="topbar">
    <div class="brand"><span class="dot"></span><span>IPTV</span></div>

    <div class="pill">
      <input id="username" placeholder="Username" autocomplete="username" value="ba24d3f" />
    </div>
    <div class="pill">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" value="36a7e66d5d" />

    </div>

    <button id="connect" class="primary">Connect</button>

    <button id="liveBtn" class="ghost" disabled>TV</button>
    <button id="moviesBtn" class="ghost" disabled>Movies</button>
    <button id="seriesBtn" class="ghost" disabled>Series</button>

    <div class="spacer"></div>

    <button id="toggleSearch" class="ghost" disabled>Search</button>
    <button id="logout" class="ghost">Logout</button>

    <div id="status"><span class="statusPill">Not connected</span></div>
  </div>

  <div id="searchWrap">
    <div class="searchBar">
      <input id="search" placeholder="Type 3+ letters to search loaded rows…" />
      <span class="kbd">Esc</span>
    </div>
    <div id="searchResults"></div>
  </div>
</header>

<!-- BROWSE PAGE -->
<div id="browsePage">
  <section class="hero">
    <div class="heroBg" id="heroBg"></div>

    <div class="heroInner">
      <div class="heroCard">
        <h1 class="heroTitle" id="heroTitle">Welcome</h1>
        <p class="heroDesc" id="heroDesc">
          Connect, then choose TV / Movies / Series. Rows will load as you scroll.
        </p>

        <div class="heroMeta" id="heroMeta">
          <span class="tag">Hero</span>
          <span class="tag">Rows</span>
          <span class="tag">Smooth</span>
        </div>

        <div class="heroActions" id="heroActions">
          <button class="primary" id="heroPlay" disabled>Play / Open</button>
          <button class="ghost" id="heroFav" disabled>★ Favorite</button>
        </div>
      </div>

      <div class="heroRight">
        <div class="heroPoster">
          <img id="heroPoster" alt="Poster" src="https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?auto=format&fit=crop&w=800&q=60" />
        </div>
      </div>
    </div>
  </section>

  <section class="content" id="content">
    <div id="rows"></div>
  </section>
</div>

<!-- SEE ALL PAGE (different page view) -->
<div id="seeAllPage">
  <div class="seeAllWrap">
    <div class="seeAllHead">
      <div class="seeAllLeft">
        <h2 class="seeAllTitle" id="seeAllTitle">Category</h2>
        <div class="seeAllSub" id="seeAllSub">Showing all items</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="seeAllBack" class="ghost">Back</button>
      </div>
    </div>

    <div class="seeAllGrid" id="seeAllGrid"></div>
  </div>
</div>

<!-- Series drawer -->
<div id="drawer">
  <div id="drawerHead">
    <h3 id="seriesTitle">Series</h3>
    <div id="drawerTools">
      <button id="copyAll" class="btn">Copy All Links</button>
      <button id="downloadM3U" class="btn primary">Download M3U</button>
      <button id="closeDrawer" class="btn">Close</button>
    </div>
  </div>
  <div id="seasons"></div>
</div>

<script>
/* =========================
   CONFIG: Host is hidden
   ========================= */
const HOST_DEFAULT = "http://line.tx-4k.com";

/* ---------------- Proxy (kept) ---------------- */
const PROXY_MODE = 'public'; // 'public' | 'none' | 'self'
const PROXY_BASE = '';

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);
const placeholderImg = 'https://via.placeholder.com/300x450?text=No+Image';

function setStatus(msg, kind){
  const cls = kind === 'ok' ? 'ok' : kind === 'err' ? 'err' : 'warn';
  $('status').innerHTML = `<span class="statusPill ${cls}">${msg}</span>`;
}
function pickJsonText(text){
  const iObj = text.indexOf('{');
  const iArr = text.indexOf('[');
  let i = -1;
  if (iArr !== -1 && (iObj === -1 || iArr < iObj)) i = iArr;
  else i = iObj;
  return i === -1 ? text : text.slice(i);
}
function safeName(s){ return (s||'').replace(/[^\w\s\-\.\(\)&]/g,'').trim(); }
function trimSlash(s){ return s.replace(/\/$/,''); }
function escapeHtml(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function wrapUrl(url){
  if (PROXY_MODE === 'none') return url;
  if (PROXY_MODE === 'self') return PROXY_BASE + url;
  return url;
}
async function fetchJsonRobust(url){
  const direct = wrapUrl(url);
  const publicTries = [
    direct,
    `https://corsproxy.io/?${encodeURIComponent(url)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://cors.isomorphic-git.org/${url}`
  ];
  const tries = (PROXY_MODE === 'public') ? publicTries : [direct];

  let lastErr = null;
  for (const u of tries){
    try{
      const r = await fetch(u, { cache:'no-store' });
      const text = await r.text();
      const cleaned = pickJsonText(text);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return JSON.parse(cleaned);
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('Fetch error');
}

/* ---------------- Local Storage (Favorites) ---------------- */
const store = {
  get favSeries(){ return JSON.parse(localStorage.getItem('fav_series_map')||'{}'); },
  set favSeries(v){ localStorage.setItem('fav_series_map', JSON.stringify(v)); },
  get favCount(){ return JSON.parse(localStorage.getItem('fav_series_count')||'{}'); },
  set favCount(v){ localStorage.setItem('fav_series_count', JSON.stringify(v)); },
};

/* ---------------- State ---------------- */
const S = {
  host: trimSlash(HOST_DEFAULT),
  user:'', pass:'',
  loggedIn:false,

  kind:'',                    // live | vod | series
  categories:[],
  catRowLoaded: new Set(),
  catCache: new Map(),
  index: [],
  indexKeys: new Set(),
  catIndexed: new Set(),

  hero: { kind:'', item:null, catId:'' },

  // see all
  seeAll: { open:false, catId:'', catName:'' }
};

const ROW_PREVIEW_COUNT = 14;
const SEARCH_LIMIT = 12;

/* ===== Only show |EN| and |AR| categories (movies + series ONLY) ===== */
function isAllowedCategoryName(name){
  const n = String(name || '').toUpperCase();
  return n.includes('|EN|') || n.includes('|AR|');
}

/* ===== Header behavior ===== */
const hdr = $('hdr');
window.addEventListener('scroll', ()=>{
  if (window.scrollY > 20) hdr.classList.add('solid');
  else hdr.classList.remove('solid');
});

/* ===== Page switching (browse <-> see all) ===== */
function showBrowsePage(push=false){
  S.seeAll.open = false;
  $('seeAllPage').style.display = 'none';
  $('browsePage').style.display = 'block';
  if (push) history.pushState({page:'browse'}, '', '#browse');
}
function showSeeAllPage(catId, catName, push=false){
  S.seeAll.open = true;
  S.seeAll.catId = String(catId);
  S.seeAll.catName = String(catName || '');
  $('browsePage').style.display = 'none';
  $('seeAllPage').style.display = 'block';
  $('seeAllTitle').textContent = S.seeAll.catName || 'Category';
  $('seeAllSub').textContent = `Showing all items • 4 per row`;
  if (push) history.pushState({page:'seeall', kind:S.kind, catId:S.seeAll.catId, catName:S.seeAll.catName}, '', `#cat=${encodeURIComponent(S.seeAll.catId)}`);
  window.scrollTo({top:0, behavior:'instant'});
}

window.addEventListener('popstate', (e)=>{
  const st = e.state || {};
  if (st.page === 'seeall' && st.catId){
    openCategoryPage(st.catId, st.catName || 'Category', false).catch(()=>{});
  } else {
    showBrowsePage(false);
  }
});

$('seeAllBack').onclick = ()=>{
  if (history.length > 1) history.back();
  else showBrowsePage(true);
};

/* ===== Search show/hide ===== */
function openSearch(){
  if (!S.loggedIn) return;
  $('searchWrap').classList.add('open');
  setTimeout(()=> $('search').focus(), 0);
}
function closeSearchIfEmpty(){
  if (($('search').value||'').trim() === ''){
    $('searchWrap').classList.remove('open');
    $('searchResults').classList.remove('show');
    $('searchResults').innerHTML = '';
  }
}
$('toggleSearch').onclick = ()=>{
  if (!S.loggedIn) return;
  const open = $('searchWrap').classList.contains('open');
  if (open) closeSearchIfEmpty();
  else openSearch();
};
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape'){
    $('search').value = '';
    closeSearchIfEmpty();
  }
});
document.addEventListener('click', (e)=>{
  const inside = $('searchWrap').contains(e.target) || $('toggleSearch').contains(e.target);
  if (!inside) closeSearchIfEmpty();
});
$('search').addEventListener('blur', ()=> setTimeout(closeSearchIfEmpty, 150));

/* =========================
   SEARCH IMPROVEMENTS (keeps UI + behavior)
   ========================= */
function normalizeText(s){
  let t = String(s || '').toLowerCase();
  try { t = t.normalize('NFKD'); } catch {}
  t = t.replace(/[\u0300-\u036f]/g,'');               // remove latin accents
  t = t.replace(/[^a-z0-9\u0600-\u06FF\s]/g,' ');    // keep arabic + latin + numbers
  t = t.replace(/\s+/g,' ').trim();
  return t;
}
function getItemName(item){
  return item?.name || item?.title || item?.stream_display_name || '';
}
function getItemIdForKind(kind, item){
  if (!item) return '';
  if (kind === 'series') return String(item.series_id || '');
  return String(item.stream_id || item.id || '');
}
function addToIndex(kind, catId, item){
  const id = getItemIdForKind(kind, item);
  if (!id) return;
  const key = `${kind}|${id}`;
  if (S.indexKeys.has(key)) return;

  const rawName = getItemName(item);
  const nameNorm = normalizeText(rawName);
  if (!nameNorm) return;

  S.indexKeys.add(key);
  S.index.push({
    nameLc: nameNorm,   // keep your existing field name
    kind,
    catId,
    item,
    poster: getPoster(kind, item),
    meta: getMeta(kind, item)
  });
}
function catKey(catId){ return `${S.kind}|${catId}`; }
function indexCategoryItems(catId, items){
  if (!Array.isArray(items)) return;
  items.forEach(it => addToIndex(S.kind, catId, it));
  S.catIndexed.add(catKey(catId));
}
function findHits(qNorm){
  return S.index
    .filter(x => x.kind === S.kind && x.nameLc.includes(qNorm))
    .slice(0, SEARCH_LIMIT);
}

let searchTimer = null;
let searchToken = 0;

function renderSearching(msg){
  $('searchResults').classList.add('show');
  $('searchResults').innerHTML = `
    <div class="resItem">
      <div class="resText">
        <div class="resName">${escapeHtml(msg)}</div>
        <div class="resMeta">Searching across categories…</div>
      </div>
    </div>
  `;
}
function renderNoMatches(){
  $('searchResults').classList.add('show');
  $('searchResults').innerHTML = `
    <div class="resItem">
      <div class="resText">
        <div class="resName">No matches found</div>
        <div class="resMeta">Tip: keep typing, or load more categories then search again.</div>
      </div>
    </div>
  `;
}
function renderHits(list){
  $('searchResults').classList.add('show');
  $('searchResults').innerHTML = '';
  list.forEach(h=>{
    const div = document.createElement('div');
    div.className = 'resItem';
    div.innerHTML = `
      <img class="resThumb" src="${h.poster || placeholderImg}" onerror="this.src='${placeholderImg}'" />
      <div class="resText">
        <div class="resName">${escapeHtml(getItemName(h.item) || 'Item')}</div>
        <div class="resMeta">${escapeHtml(h.meta || '')}</div>
      </div>
    `;
    div.onclick = ()=>{
      if (S.seeAll.open){
        setHero(S.kind, h.item, h.catId);
        $('searchWrap').classList.remove('open');
        $('searchResults').classList.remove('show');
        return;
      }

      const rowId = `row-${S.kind}-${h.catId}`;
      const el = document.getElementById(rowId);
      if (el){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.animate([{filter:'brightness(1.0)'},{filter:'brightness(1.25)'},{filter:'brightness(1.0)'}],{duration:600});
      }

      // ensure row visually loads
      loadCategoryRow(h.catId).catch(()=>{});

      setHero(S.kind, h.item, h.catId);

      $('searchWrap').classList.remove('open');
      $('searchResults').classList.remove('show');
    };
    $('searchResults').appendChild(div);
  });
}

async function runSearch(){
  const raw = ($('search').value||'').trim();
  const qNorm = normalizeText(raw);

  if (qNorm.length < 3){
    $('searchResults').classList.remove('show');
    $('searchResults').innerHTML = '';
    return;
  }

  const token = ++searchToken;

  // Fast: search already indexed
  let hits = findHits(qNorm);
  if (hits.length){
    renderHits(hits);
    return;
  }

  // Scan more categories to make search actually work
  renderSearching('Searching…');

  const catIds = S.categories.map(c => String(c.category_id));
  const SCAN_LIMIT = (S.kind === 'live') ? 10 : 25;
  let scanned = 0;

  for (const cid of catIds){
    if (token !== searchToken) return;

    const k = `${S.kind}|${cid}`;
    if (S.catIndexed.has(k)) continue;

    renderSearching(`Searching… (${scanned + 1})`);

    try{
      const items = await fetchCategoryItems(cid);
      indexCategoryItems(cid, items);
    }catch(e){ /* ignore */ }

    hits = findHits(qNorm);
    if (hits.length) break;

    scanned++;
    if (scanned >= SCAN_LIMIT) break;
  }

  if (token !== searchToken) return;

  if (!hits.length) renderNoMatches();
  else renderHits(hits);
}

$('search').addEventListener('input', ()=>{
  if (searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> runSearch().catch(()=>{}), 220);
});

/* ---------------- Login ---------------- */
$('connect').onclick = async ()=>{
  S.user = $('username').value.trim();
  S.pass = $('password').value.trim();
  if (!S.user || !S.pass) return setStatus('Enter username & password','err');

  setStatus('Connecting…','warn');
  try{
    const url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}`;
    const data = await fetchJsonRobust(url);

    if (data.user_info && String(data.user_info.auth) === '1'){
      S.loggedIn = true;
      $('liveBtn').disabled = false;
      $('moviesBtn').disabled = false;
      $('seriesBtn').disabled = false;
      $('toggleSearch').disabled = false;
      setStatus('Login OK','ok');

      $('heroTitle').textContent = 'Connected';
      $('heroDesc').textContent = 'Choose TV / Movies / Series to start.';
      $('heroPlay').disabled = true;
      $('heroFav').disabled = true;
      $('rows').innerHTML = '';
      showBrowsePage(true);
    } else {
      S.loggedIn = false;
      setStatus('Invalid login','err');
    }
  }catch(e){
    console.error(e);
    S.loggedIn = false;
    setStatus('Cannot connect (API). Check host or proxy.','err');
  }
};
$('logout').onclick = ()=> location.reload();

$('liveBtn').onclick  = ()=> loadKind('live');
$('moviesBtn').onclick= ()=> loadKind('vod');
$('seriesBtn').onclick= ()=> loadKind('series');

/* ---------------- Hero ---------------- */
function setHero(kind, item, catId){
  S.hero = { kind, item, catId };

  const name = item?.name || (kind==='live'?'Live TV':'Title');
  $('heroTitle').textContent = name;

  const desc =
    kind==='live' ? 'Tap Play to open the stream.' :
    kind==='vod'  ? 'Tap Play to open the movie.' :
                    'Tap Play to open the series episodes.';
  $('heroDesc').textContent = desc;

  const poster = getPoster(kind, item) || $('heroPoster').src;
  $('heroPoster').src = poster;
  $('heroPoster').onerror = ()=> $('heroPoster').src = placeholderImg;

  $('heroBg').style.backgroundImage =
    `linear-gradient(90deg, rgba(7,9,15,.92) 0%, rgba(7,9,15,.55) 45%, rgba(7,9,15,.20) 75%, rgba(7,9,15,.92) 100%),
     linear-gradient(0deg, rgba(7,9,15,.98) 0%, rgba(7,9,15,.55) 28%, rgba(7,9,15,.15) 60%, rgba(7,9,15,.92) 100%),
     url('${poster}')`;

  $('heroMeta').innerHTML = `
    <span class="tag">${kind==='live'?'TV':kind==='vod'?'Movies':'Series'}</span>
    <span class="tag">${catId ? `Category ${catId}` : '—'}</span>
  `;

  $('heroPlay').disabled = false;

  if (kind === 'series'){
    $('heroFav').disabled = false;
    const isFav = !!store.favSeries[String(item.series_id)];
    $('heroFav').textContent = isFav ? '★ Favorited' : '★ Favorite';
  } else {
    $('heroFav').disabled = true;
    $('heroFav').textContent = '★ Favorite';
  }
}

$('heroPlay').onclick = ()=>{
  const {kind, item} = S.hero;
  if (!item) return;

  if (kind === 'live'){
    const m3u8 = `${S.host}/live/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${item.stream_id}.m3u8`;
    window.open(m3u8,'_blank','noopener');
  } else if (kind === 'vod'){
    const ext = (item.container_extension || 'mp4').replace(/^\./,'');
    const url = `${S.host}/movie/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${item.stream_id}.${ext}`;
    window.open(url,'_blank','noopener');
  } else {
    openSeries(item);
  }
};

$('heroFav').onclick = ()=>{
  const {kind, item} = S.hero;
  if (kind !== 'series' || !item) return;
  const fakeBtn = { classList:{ add(){}, remove(){} }, textContent:'' };
  toggleFavSeries(item, fakeBtn);
  const isFav = !!store.favSeries[String(item.series_id)];
  $('heroFav').textContent = isFav ? '★ Favorited' : '★ Favorite';
};

/* ---------------- Load kind -> build rows ---------------- */
async function loadKind(kind){
  if (!S.loggedIn) return setStatus('Login first','err');

  closeDrawer();
  $('search').value = '';
  $('searchResults').classList.remove('show');
  $('searchResults').innerHTML = '';
  $('searchWrap').classList.remove('open');

  showBrowsePage(true);

  S.kind = kind;
  S.categories = [];
  S.catRowLoaded.clear();
  S.catCache.clear();
  S.index = [];
  S.indexKeys = new Set();
  S.catIndexed = new Set();

  $('rows').innerHTML = '';

  $('heroTitle').textContent = kind==='live'?'TV':'Browse';
  $('heroDesc').textContent = 'Scroll down — each category is a horizontal slider row.';
  $('heroPlay').disabled = true;
  $('heroFav').disabled = true;

  setStatus('Loading categories…','warn');

  try{
    let url = '';
    if (kind==='live'){
      url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_live_categories`;
    } else if (kind==='vod'){
      url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_vod_categories`;
    } else {
      url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_series_categories`;
    }

    const cats = await fetchJsonRobust(url);
    const allCats = Array.isArray(cats) ? cats : [];

    // ✅ TV shows ALL categories
    // ✅ Movies/Series keep ONLY |EN| and |AR|
    if (kind === 'live') S.categories = allCats;
    else S.categories = allCats.filter(c => isAllowedCategoryName(c.category_name));

    if (!S.categories.length){
      $('rows').innerHTML = `<p style="color:var(--muted)">No categories found.</p>`;
      setStatus('No categories','err');
      return;
    }

    S.categories.forEach((c)=>{
      const catId = String(c.category_id);
      const catName = c.category_name || `Category ${catId}`;

      const sec = document.createElement('section');
      sec.dataset.catId = catId;
      sec.setAttribute('data-cat-id', catId);
      sec.id = `row-${kind}-${catId}`;

      sec.innerHTML = `
        <div class="sectionHead">
          <div>
            <h2 class="sectionTitle">${escapeHtml(catName)}</h2>
            <div class="sectionSub">${kind==='live'?'Channels':'Titles'} load when this row becomes visible</div>
          </div>
          <button class="ghost" data-seeall="${catId}">See all</button>
        </div>
        <div class="row" id="slider-${kind}-${catId}">
          ${skeletonCards(10)}
        </div>
      `;

      $('rows').appendChild(sec);

      sec.querySelector('[data-seeall]').onclick = ()=> openCategoryPage(catId, catName, true);
    });

    setupLazyLoading();
    setStatus('Ready','ok');

    setTimeout(()=>{
      const firstTwo = S.categories.slice(0,2).map(x=>String(x.category_id));
      firstTwo.forEach(id=> loadCategoryRow(id).catch(()=>{}));
    }, 120);

  }catch(e){
    console.error(e);
    setStatus('Failed to load categories','err');
    $('rows').innerHTML = `<p style="color:#ef4444">Could not load categories (proxy/host).</p>`;
  }
}

/* ---------------- Lazy load rows ---------------- */
let rowObserver = null;
function setupLazyLoading(){
  if (rowObserver) rowObserver.disconnect();

  rowObserver = new IntersectionObserver((entries)=>{
    entries.forEach(ent=>{
      if (ent.isIntersecting){
        const sec = ent.target;
        const catId = sec.dataset.catId;
        loadCategoryRow(catId).catch(()=>{});
      }
    });
  }, { root:null, threshold:0.15 });

  document.querySelectorAll('section[data-cat-id]').forEach(sec=> rowObserver.observe(sec));
}

async function loadCategoryRow(catId){
  const key = catKey(catId);
  if (S.catRowLoaded.has(key)) return;

  const slider = document.getElementById(`slider-${S.kind}-${catId}`);
  if (!slider) return;

  S.catRowLoaded.add(key);

  try{
    const items = await fetchCategoryItems(catId);

    // ✅ index FULL category for search (no UI change)
    indexCategoryItems(catId, items);

    const preview = items.slice(0, ROW_PREVIEW_COUNT);

    slider.innerHTML = '';
    preview.forEach(item=>{
      slider.appendChild(makeCard(item, catId));
    });

    if (!preview.length){
      slider.innerHTML = `<div style="color:var(--muted); padding:10px 6px;">No items.</div>`;
    }
  }catch(e){
    console.error(e);
    slider.innerHTML = `<div style="color:#ef4444; padding:10px 6px;">Failed to load this row.</div>`;
  }
}

async function fetchCategoryItems(catId){
  const key = catKey(catId);
  if (S.catCache.has(key)) return S.catCache.get(key);

  let url = '';
  if (S.kind==='live'){
    url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_live_streams&category_id=${encodeURIComponent(catId)}`;
  } else if (S.kind==='vod'){
    url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_vod_streams&category_id=${encodeURIComponent(catId)}`;
  } else {
    url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_series&category_id=${encodeURIComponent(catId)}`;
  }

  const data = await fetchJsonRobust(url);
  const arr = Array.isArray(data) ? data : [];
  S.catCache.set(key, arr);
  return arr;
}

/* ---------------- SEE ALL PAGE loader ---------------- */
async function openCategoryPage(catId, catName, pushState=true){
  if (!S.loggedIn) return setStatus('Login first','err');

  closeDrawer();
  $('search').value = '';
  $('searchResults').classList.remove('show');
  $('searchResults').innerHTML = '';
  $('searchWrap').classList.remove('open');

  showSeeAllPage(catId, catName, pushState);

  const grid = $('seeAllGrid');
  grid.innerHTML = `<div style="grid-column:1/-1; color:var(--muted); padding:8px 0;">Loading…</div>`;

  try{
    const items = await fetchCategoryItems(catId);

    // ✅ index FULL category for search
    indexCategoryItems(catId, items);

    grid.innerHTML = '';

    if (!items.length){
      grid.innerHTML = `<div style="grid-column:1/-1; color:var(--muted); padding:8px 0;">No items.</div>`;
      return;
    }

    items.forEach(item=>{
      grid.appendChild(makeCard(item, catId));
    });

  }catch(e){
    console.error(e);
    grid.innerHTML = `<div style="grid-column:1/-1; color:#ef4444; padding:8px 0;">Failed to load category.</div>`;
  }
}

/* ---------------- Cards ---------------- */
function getPoster(kind, item){
  if (!item) return '';
  if (kind==='live'){
    return (item.stream_icon && item.stream_icon !== 'null') ? item.stream_icon : '';
  }
  if (kind==='vod'){
    return (item.stream_icon && item.stream_icon !== 'null') ? item.stream_icon : '';
  }
  return (item.cover && item.cover !== 'null') ? item.cover : (item.stream_icon || '');
}

function getMeta(kind, item){
  if (!item) return '';
  if (kind==='live') return `ID ${item.stream_id || ''}`;
  if (kind==='vod')  return (item.container_extension || 'mp4').toUpperCase();
  return item.releaseDate || `ID ${item.series_id || ''}`;
}

function makeCard(item, catId){
  const div = document.createElement('div');
  div.className = 'card';

  const poster = getPoster(S.kind, item) || placeholderImg;
  const name = item.name || (S.kind==='live'?'Channel':S.kind==='vod'?'Movie':'Series');
  const meta = getMeta(S.kind, item);

  div.innerHTML = `
    <img class="poster" src="${poster}" onerror="this.src='${placeholderImg}'" />
    <div class="cardInfo">
      <div class="name">${escapeHtml(name)}</div>
      <div class="meta">${escapeHtml(meta)}</div>
    </div>
  `;

  if (S.kind==='series'){
    const fav = document.createElement('div');
    const id = String(item.series_id);
    const isFav = !!store.favSeries[id];
    fav.className = 'favBtn ' + (isFav ? 'on' : 'off');
    fav.textContent = isFav ? '★' : '☆';
    fav.title = 'Toggle favorite';
    fav.onclick = (e)=>{
      e.stopPropagation();
      toggleFavSeries(item, fav);
      if (S.hero.kind==='series' && S.hero.item && String(S.hero.item.series_id) === id){
        $('heroFav').textContent = (!!store.favSeries[id]) ? '★ Favorited' : '★ Favorite';
      }
    };
    div.appendChild(fav);
  }

  div.addEventListener('mouseenter', ()=>{
    if ($('browsePage').style.display !== 'none'){
      setHero(S.kind, item, catId);
      $('heroPlay').disabled = false;
    }
  });

  div.onclick = ()=>{
    if ($('browsePage').style.display !== 'none'){
      setHero(S.kind, item, catId);
      $('heroPlay').disabled = false;
    }

    if (S.kind==='live'){
      const m3u8 = `${S.host}/live/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${item.stream_id}.m3u8`;
      window.open(m3u8,'_blank','noopener');
    } else if (S.kind==='vod'){
      const ext = (item.container_extension || 'mp4').replace(/^\./,'');
      const url = `${S.host}/movie/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${item.stream_id}.${ext}`;
      window.open(url,'_blank','noopener');
    } else {
      openSeries(item);
    }
  };

  return div;
}

function skeletonCards(n){
  let out = '';
  for (let i=0;i<n;i++){
    out += `
      <div class="card">
        <div class="poster skeleton"></div>
        <div class="cardInfo">
          <div class="name skeleton" style="height:14px;border-radius:8px"></div>
          <div class="meta skeleton" style="height:12px;border-radius:8px;margin-top:8px;width:70%"></div>
        </div>
      </div>
    `;
  }
  return out;
}

/* ---------------- Favorites (Series) ---------------- */
function toggleFavSeries(item, btnEl){
  const id = String(item.series_id);
  const favMap = store.favSeries;

  if (favMap[id]){
    delete favMap[id];
    btnEl.classList.remove('on'); btnEl.classList.add('off');
    btnEl.textContent = '☆';
  } else {
    favMap[id] = {
      id,
      name: item.name || 'Series',
      cover: item.cover || item.stream_icon || '',
      category_id: item.category_id || '',
      releaseDate: item.releaseDate || ''
    };
    btnEl.classList.add('on'); btnEl.classList.remove('off');
    btnEl.textContent = '★';
  }
  store.favSeries = favMap;
}

/* ---------------- Series drawer ---------------- */
$('closeDrawer').onclick = ()=> closeDrawer();
$('copyAll').onclick = ()=>{
  if (!S.currentSeries) return;
  const links = buildAllEpisodeLinks(S.currentSeasons);
  copyText(links.join('\n'));
  setStatus('Copied episode links','ok');
};
$('downloadM3U').onclick = ()=>{
  if (!S.currentSeries) return;
  const links = buildAllEpisodeLinks(S.currentSeasons);
  const m3u = buildM3U(links, S.currentSeries.name);
  downloadText(m3u, `${safeName(S.currentSeries.name || 'series')}.m3u`);
};

async function openSeries(serie){
  $('seriesTitle').textContent = serie.name || 'Series';
  S.currentSeries = { id: String(serie.series_id), name: serie.name || 'Series' };
  $('seasons').innerHTML = '<div style="color:var(--muted);padding:8px">Loading seasons & episodes…</div>';
  $('drawer').style.display = 'block';

  const counts = store.favCount;
  counts[S.currentSeries.id] = (counts[S.currentSeries.id] || 0) + 1;
  store.favCount = counts;

  try{
    const url = `${S.host}/player_api.php?username=${encodeURIComponent(S.user)}&password=${encodeURIComponent(S.pass)}&action=get_series_info&series_id=${encodeURIComponent(serie.series_id)}`;
    const info = await fetchJsonRobust(url);

    const episodesBySeason = info.episodes || {};
    S.currentSeasons = episodesBySeason;

    const seasonsBox = $('seasons');
    seasonsBox.innerHTML = '';
    const seasonNums = Object.keys(episodesBySeason).sort((a,b)=>Number(a)-Number(b));

    if (!seasonNums.length){
      seasonsBox.innerHTML = '<div style="color:var(--muted);padding:8px">No episodes found.</div>';
      return;
    }

    seasonNums.forEach(seasonNo=>{
      const eps = episodesBySeason[seasonNo] || [];

      const det = document.createElement('details');
      const sum = document.createElement('summary');
      sum.textContent = `Season ${seasonNo} • ${eps.length} episode(s)`;

      const wrap = document.createElement('div');
      wrap.className = 'episodes';

      eps.forEach(ep=>{
        const row = document.createElement('div');
        row.className = 'ep';

        const title = document.createElement('div');
        title.className = 'epName';
        title.textContent = ep.title || `Episode ${ep.episode_num || ''}`;

        const ext = (ep.container_extension || 'mp4').replace(/^\./,'');
        const epUrl = `${S.host}/series/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${ep.id}.${ext}`;

        const open = document.createElement('a');
        open.className = 'linkBtn';
        open.textContent = 'Open';
        open.href = epUrl;
        open.target = '_blank';
        open.rel = 'noopener';

        const copy = document.createElement('button');
        copy.className = 'btn';
        copy.textContent = 'Copy';
        copy.onclick = async ()=>{
          await copyText(epUrl);
          setStatus('Copied','ok');
        };

        row.appendChild(title);
        row.appendChild(open);
        row.appendChild(copy);
        wrap.appendChild(row);
      });

      det.appendChild(sum);
      det.appendChild(wrap);
      $('seasons').appendChild(det);
    });

    const first = $('seasons').querySelector('details');
    if (first) first.open = true;

  }catch(e){
    console.error(e);
    $('seasons').innerHTML = `<div style="color:#ef4444;padding:8px">Failed to load episodes.</div>`;
  }
}

function closeDrawer(){
  $('drawer').style.display='none';
  S.currentSeries=null;
  S.currentSeasons={};
}

/* ---------------- Link builders & utils ---------------- */
function buildAllEpisodeLinks(bySeason){
  const links = [];
  const seasonNums = Object.keys(bySeason).sort((a,b)=>Number(a)-Number(b));
  seasonNums.forEach(s=>{
    (bySeason[s]||[]).forEach(ep=>{
      const ext = (ep.container_extension || 'mp4').replace(/^\./,'');
      links.push(`${S.host}/series/${encodeURIComponent(S.user)}/${encodeURIComponent(S.pass)}/${ep.id}.${ext}`);
    });
  });
  return links;
}
function buildM3U(links, title='Playlist'){
  let m3u = '#EXTM3U\n';
  links.forEach((u, i)=>{
    m3u += `#EXTINF:-1,${title} ${String(i+1).padStart(2,'0')}\n${u}\n`;
  });
  return m3u;
}
async function copyText(txt){
  try { await navigator.clipboard.writeText(txt); } catch {}
}
function downloadText(txt, filename){
  const blob = new Blob([txt], {type:'audio/x-mpegurl'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename || 'playlist.m3u';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

/* ===== Default route ===== */
history.replaceState({page:'browse'}, '', '#browse');
</script>

</body>
</html>
