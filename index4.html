<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>STARTV</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    /* Base */
    --bg:#04050a;
    --bg2:#060717;
    --glass:rgba(14,16,24,.62);
    --glass2:rgba(12,14,22,.88);
    --text:#f3f5ff;
    --muted:rgba(243,245,255,.68);

    /* Accent */
    --accent:#e50914;
    --accent2:#ff3340;
    --glow:rgba(229,9,20,.35);

    /* UI */
    --border:rgba(255,255,255,.10);
    --border2:rgba(255,255,255,.14);
    --shadow:0 18px 60px rgba(0,0,0,.55);
    --radius:22px;
    --railW:86px;

    /* Card */
    --cardW:168px;
    --cardH:238px;

    /* Focus */
    --focus: 0 0 0 3px rgba(255,255,255,.20), 0 0 0 6px rgba(229,9,20,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1100px 700px at 12% 8%, rgba(229,9,20,.16), transparent 60%),
      radial-gradient(900px 600px at 80% 16%, rgba(92,86,255,.12), transparent 62%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    overflow:hidden;
  }

  a{color:inherit;text-decoration:none}
  button{font-family:inherit}
  .muted{color:var(--muted)}

  /* ===== Layout ===== */
  #app{
    height:100%;
    display:grid;
    grid-template-columns: var(--railW) 1fr;
  }

  /* ===== Rail ===== */
  #rail{
    position:relative;
    border-right:1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), rgba(0,0,0,.18);
    backdrop-filter: blur(18px);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:14px 10px;
    gap:12px;
  }

  #brand{
    width:54px;height:54px;border-radius:18px;
    display:grid;place-items:center;
    background:
      radial-gradient(18px 18px at 35% 30%, rgba(255,255,255,.20), transparent 55%),
      linear-gradient(180deg, rgba(229,9,20,.75), rgba(229,9,20,.30));
    border:1px solid rgba(255,255,255,.16);
    box-shadow: 0 16px 36px rgba(229,9,20,.25);
    font-weight:900;
    letter-spacing:.5px;
  }

  .railBtn{
    width:54px;height:54px;border-radius:18px;
    display:grid;place-items:center;
    cursor:pointer;
    border:1px solid transparent;
    background: rgba(255,255,255,.04);
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    user-select:none;
  }
  .railBtn:hover{background: rgba(255,255,255,.06)}
  .railBtn.active{
    background: rgba(229,9,20,.14);
    border-color: rgba(229,9,20,.35);
    box-shadow: 0 16px 36px rgba(229,9,20,.14);
  }

  .railIcon{font-size:18px;opacity:.92}
  #railBottom{margin-top:auto;display:flex;flex-direction:column;gap:10px;align-items:center}

  /* ===== Main ===== */
  #main{
    position:relative;
    height:100%;
    overflow:hidden;
  }

  #topBar{
    position:absolute;
    inset:0 0 auto 0;
    height:78px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 18px 12px 18px;
    z-index:10;
    background:
      linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.08));
    pointer-events:none;
  }
  #topLeft, #topRight{display:flex;align-items:center;gap:12px;pointer-events:auto}
  #pill{
    padding:10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(16px);
    display:flex;align-items:center;gap:10px;
    box-shadow: 0 14px 40px rgba(0,0,0,.24);
  }
  #kindLabel{
    font-weight:800;
    letter-spacing:.2px;
  }

  #statusPill{
    padding:10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(16px);
    display:flex;align-items:center;gap:10px;
    box-shadow: 0 14px 40px rgba(0,0,0,.24);
    max-width:min(560px, 74vw);
  }
  #statusDot{
    width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25);
    box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    flex:0 0 auto;
  }
  #statusText{
    font-size:.9rem;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ===== Hero ===== */
  #hero{
    position:absolute;
    inset:0;
    overflow:auto;
    padding:86px 22px 120px 22px;
    scroll-behavior:smooth;
  }

  #heroCard{
    position:relative;
    min-height: 320px;
    border-radius: var(--radius);
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(1200px 500px at 15% 0%, rgba(229,9,20,.20), transparent 60%),
      radial-gradient(1000px 500px at 78% 10%, rgba(92,86,255,.14), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  #heroMedia{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    filter: saturate(1.05) contrast(1.05);
    opacity:.32;
    transform: scale(1.02);
  }
  #heroShade{
    position:absolute;
    inset:0;
    background:
      linear-gradient(90deg, rgba(0,0,0,.75), rgba(0,0,0,.20) 55%, rgba(0,0,0,.18)),
      linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.50));
  }

  #heroInner{
    position:relative;
    padding:22px 22px 18px 22px;
    display:flex;
    gap:18px;
    align-items:flex-end;
    min-height: 320px;
  }
  #heroPoster{
    width:170px;height:255px;
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    box-shadow: 0 20px 55px rgba(0,0,0,.55);
    overflow:hidden;
    flex:0 0 auto;
  }
  #heroPoster img{width:100%;height:100%;object-fit:cover;display:block}
  #heroMeta{max-width: 860px}
  #heroTitle{
    font-size: clamp(1.2rem, 2.6vw, 2.25rem);
    font-weight: 900;
    letter-spacing: .2px;
    margin:0 0 6px 0;
    line-height:1.05;
  }
  #heroSub{
    color: var(--muted);
    margin:0 0 14px 0;
    max-width: 70ch;
  }

  .btn{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.07);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .btn:hover{background: rgba(255,255,255,.10)}
  .btn:active{transform: translateY(1px)}
  .btn.primary{
    background: linear-gradient(180deg, rgba(229,9,20,.95), rgba(229,9,20,.72));
    border-color: rgba(229,9,20,.45);
    box-shadow: 0 18px 44px rgba(229,9,20,.22);
  }
  .btn.primary:hover{
    background: linear-gradient(180deg, rgba(255,51,64,.95), rgba(229,9,20,.72));
  }
  .linkBtn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.07);
    cursor:pointer;
  }

  #heroActions{display:flex;gap:10px;flex-wrap:wrap}
  #heroActions .btn, #heroActions .linkBtn{font-weight:700}

  /* ===== Rows ===== */
  .section{
    margin-top: 20px;
  }
  .sectionHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin: 18px 4px 10px 4px;
    gap:12px;
  }
  .sectionTitle{
    font-weight:900;
    letter-spacing:.2px;
    font-size: 1.05rem;
  }
  .seeAll{
    font-weight:800;
    color: rgba(255,255,255,.78);
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    padding:8px 10px;
    border-radius: 999px;
    cursor:pointer;
  }
  .seeAll:hover{background: rgba(255,255,255,.08)}

  .row{
    display:flex;
    gap:12px;
    overflow:auto;
    padding: 2px 4px 12px 4px;
    scroll-snap-type:x proximity;
  }
  .row::-webkit-scrollbar{height:8px}
  .row::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12);border-radius:99px}
  .row::-webkit-scrollbar-track{background: rgba(255,255,255,.04);border-radius:99px}

  .card{
    width: var(--cardW);
    scroll-snap-align:start;
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.05);
    overflow:hidden;
    cursor:pointer;
    user-select:none;
    transition: transform .14s ease, border-color .14s ease, background .14s ease;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    flex:0 0 auto;
  }
  .card:hover{transform: translateY(-2px); border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.07)}
  .cardPoster{
    width:100%;
    height: var(--cardH);
    background: rgba(0,0,0,.22);
  }
  .cardPoster img{width:100%;height:100%;object-fit:cover;display:block}
  .cardMeta{
    padding: 10px 10px 12px 10px;
  }
  .cardTitle{
    font-weight: 800;
    font-size: .92rem;
    line-height: 1.1;
    margin-bottom: 4px;
  }
  .cardSub{
    color: var(--muted);
    font-size: .78rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* ===== Search ===== */
  #searchPanel{
    display:none;
    position:fixed;
    inset: 96px 24px auto calc(var(--railW) + 24px);
    z-index:250;
    border-radius: 22px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,12,18,.92);
    backdrop-filter: blur(22px);
    box-shadow: 0 24px 80px rgba(0,0,0,.62);
    overflow:hidden;
  }
  #searchTop{
    display:flex;
    gap:10px;
    padding: 12px 12px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
  }
  #searchInput{
    flex:1;
    padding: 12px 12px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: var(--text);
    outline:none;
    font-weight:700;
  }
  #searchInput::placeholder{color: rgba(243,245,255,.45)}
  #searchClose{white-space:nowrap}
  #searchResults{
    max-height: 62vh;
    overflow:auto;
    padding: 10px 12px 14px 12px;
  }
  .resultRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 10px 10px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius: 16px;
    margin-bottom:10px;
  }
  .resultName{font-weight:900}
  .resultBtns{display:flex;gap:8px;flex-wrap:wrap}

  /* ===== Series Drawer ===== */
  #drawer{
    display:none;
    position:fixed;
    inset:auto 0 0 var(--railW);
    background:
      radial-gradient(900px 260px at 18% 0%, rgba(229,9,20,.12), transparent 60%),
      rgba(10,12,18,.94);
    border-top:1px solid rgba(255,255,255,.10);
    max-height:72vh;
    overflow:auto;
    z-index:260;
    backdrop-filter: blur(18px);
    box-shadow: 0 -22px 80px rgba(0,0,0,.62);
  }
  #drawerHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background:
      radial-gradient(900px 260px at 20% 0%, rgba(229,9,20,.14), transparent 60%),
      rgba(255,255,255,.03);
    position:sticky;
    top:0;
    z-index:2;
    backdrop-filter: blur(18px);
  }
  #drawer h3{margin:0;font-weight:900}
  #drawerClose{white-space:nowrap}
  #drawerBody{padding:12px 14px}
  .ep{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    border-radius: 16px;
    margin-bottom:10px;
  }
  .epName{font-weight:900}
  .epBtns{display:flex;gap:8px;flex-wrap:wrap}

  /* ===== MOVIE DRAWER (NEW) ===== */
  #movieDrawer{
    display:none;
    position:fixed;
    inset:auto 0 0 var(--railW);
    background:
      radial-gradient(900px 260px at 18% 0%, rgba(229,9,20,.12), transparent 60%),
      rgba(10,12,18,.94);
    border-top:1px solid rgba(255,255,255,.10);
    max-height:72vh;
    overflow:auto;
    z-index:260;
    backdrop-filter: blur(18px);
    box-shadow: 0 -22px 80px rgba(0,0,0,.62);
  }
  #movieDrawerHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background:
      radial-gradient(900px 260px at 20% 0%, rgba(229,9,20,.14), transparent 60%),
      rgba(255,255,255,.03);
    position:sticky;
    top:0;
    z-index:2;
    backdrop-filter: blur(18px);
  }
  #movieDrawer h3{margin:0;font-weight:900}
  #movieTools{display:flex;gap:8px;flex-wrap:wrap}

  /* ===== Player ===== */
  #playerModal{
    display:none;
    position:fixed;
    inset:0;
    z-index:300;
    background: rgba(0,0,0,.85);
    backdrop-filter: blur(8px);
  }
  #playerShell{
    position:absolute;
    inset: 18px;
    border-radius: 24px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,12,18,.92);
    box-shadow: 0 28px 100px rgba(0,0,0,.72);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  #playerTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding: 12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
  }
  #playerTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  #playerActions{display:flex;gap:8px;flex-wrap:wrap}
  #videoWrap{
    position:relative;
    flex:1;
    background: #000;
  }
  #video{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain;
    background:#000;
  }

  /* ===== Focus helper for TV remote ===== */
  .tvFocus{
    outline:none !important;
    box-shadow: var(--focus) !important;
    border-color: rgba(255,255,255,.25) !important;
  }

  /* Responsive */
  @media (max-width: 820px){
    :root{ --railW:74px; --cardW:150px; --cardH:212px; }
    #heroInner{flex-direction:column;align-items:flex-start}
    #heroPoster{width:150px;height:225px}
    #searchPanel{inset: 96px 14px auto calc(var(--railW) + 14px)}
  }
</style>
</head>

<body>
<div id="app">
  <!-- RAIL -->
  <aside id="rail">
    <div id="brand" tabindex="0" data-focusable="1">TV</div>

    <div id="liveBtn" class="railBtn active" title="Live" tabindex="0" data-focusable="1"><div class="railIcon">üì∫</div></div>
    <div id="moviesBtn" class="railBtn" title="Movies" tabindex="0" data-focusable="1"><div class="railIcon">üé¨</div></div>
    <div id="seriesBtn" class="railBtn" title="Series" tabindex="0" data-focusable="1"><div class="railIcon">üéûÔ∏è</div></div>

    <div style="height:8px"></div>

    <div id="searchBtn" class="railBtn" title="Search" tabindex="0" data-focusable="1"><div class="railIcon">üîé</div></div>

    <div id="railBottom">
      <div id="reloadBtn" class="railBtn" title="Reload" tabindex="0" data-focusable="1"><div class="railIcon">‚Üª</div></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="main">
    <div id="topBar">
      <div id="topLeft">
        <div id="pill">
          <span class="muted">Mode</span>
          <span id="kindLabel">Live</span>
        </div>
      </div>

      <div id="topRight">
        <div id="statusPill">
          <span id="statusDot"></span>
          <div id="statusText">Ready</div>
        </div>
      </div>
    </div>

    <div id="hero">
      <div id="heroCard">
        <div id="heroMedia"></div>
        <div id="heroShade"></div>

        <div id="heroInner">
          <div id="heroPoster"><img id="heroPosterImg" alt="" /></div>
          <div id="heroMeta">
            <h1 id="heroTitle">STARTV</h1>
            <p id="heroSub" class="muted">Connect to your legal IPTV provider, browse categories, and play streams.</p>
            <div id="heroActions">
              <button id="heroPlay" class="btn primary" tabindex="0" data-focusable="1">Play</button>
              <a id="heroOpen" class="linkBtn" href="#" target="_blank" rel="noopener" tabindex="0" data-focusable="1">Open</a>
              <button id="heroCopy" class="btn" tabindex="0" data-focusable="1">Copy</button>
            </div>
          </div>
        </div>
      </div>

      <!-- rows go here -->
      <div id="rows"></div>
    </div>
  </main>
</div>

<!-- SEARCH -->
<div id="searchPanel">
  <div id="searchTop">
    <input id="searchInput" placeholder="Search‚Ä¶" autocomplete="off" />
    <button id="searchClose" class="btn">Close</button>
  </div>
  <div id="searchResults"></div>
</div>

<!-- SERIES DRAWER -->
<div id="drawer">
  <div id="drawerHead">
    <h3 id="drawerTitle">Series</h3>
    <button id="drawerClose" class="btn">Close</button>
  </div>
  <div id="drawerBody"></div>
</div>

<!-- MOVIE DRAWER (NEW) -->
<div id="movieDrawer">
  <div id="movieDrawerHead">
    <h3 id="movieTitle">Movie</h3>
    <div id="movieTools">
      <button id="moviePlay" class="btn primary" tabindex="0" data-focusable="1">Play</button>
      <a id="movieOpen" class="linkBtn" href="#" target="_blank" rel="noopener" tabindex="0" data-focusable="1">Open</a>
      <button id="movieCopy" class="btn" tabindex="0" data-focusable="1">Copy</button>
      <button id="movieClose" class="btn" tabindex="0" data-focusable="1">Close</button>
    </div>
  </div>
  <div id="movieBody" style="padding:12px 14px; color:var(--muted)"></div>
</div>

<!-- PLAYER -->
<div id="playerModal">
  <div id="playerShell">
    <div id="playerTop">
      <div id="playerTitle">Playing‚Ä¶</div>
      <div id="playerActions">
        <button id="playerFs" class="btn">Fullscreen</button>
        <a id="playerOpen" class="linkBtn" href="#" target="_blank" rel="noopener">Open</a>
        <button id="playerCopy" class="btn">Copy</button>
        <button id="playerClose" class="btn">Close</button>
      </div>
    </div>
    <div id="videoWrap">
      <video id="video" controls playsinline></video>
    </div>
  </div>
</div>

<!-- HLS for m3u8 in browsers that don't support it -->
<script src="https://unpkg.com/hls.js@1.5.18/dist/hls.min.js"></script>

<script>
/* =========================================================
   STARTV ‚Äî Single file
   - LIVE rows show 3 items per category (Movies/Series show 14)
   - Movies click opens a Series-style drawer (Open / Copy / Play)
   NOTE: Use content you have rights to. Configure your own provider.
   ========================================================= */

/* ====== CONFIG (EDIT THESE) ====== */
const CONFIG = {
  APP_NAME: "STARTV",
  HOST: "https://YOUR_HOST_HERE",     // e.g. https://example.com  (must be https if hosted on https)
  USERNAME: "YOUR_USERNAME",
  PASSWORD: "YOUR_PASSWORD",

  // Optional CORS/mixed-content proxy (ONLY if you control it):
  // If set, requests go to: PROXY + encodeURIComponent(realUrl)
  PROXY: "" // e.g. "https://your-proxy.com/?url="
};

const placeholderImg =
  "data:image/svg+xml;charset=utf-8," +
  encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='450'>
  <defs><linearGradient id='g' x1='0' x2='1'><stop stop-color='#151a2a'/><stop offset='1' stop-color='#0b0f1a'/></linearGradient></defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <circle cx='110' cy='160' r='62' fill='rgba(255,255,255,.08)'/>
  <rect x='54' y='260' width='192' height='22' rx='11' fill='rgba(255,255,255,.10)'/>
  <rect x='76' y='296' width='148' height='16' rx='8' fill='rgba(255,255,255,.08)'/>
  </svg>`);

/* ====== STATE ====== */
const S = {
  kind: "live",            // live | vod | series
  cats: [],
  itemsByCat: new Map(),   // catId -> items[]
  catNameById: new Map(),
  hero: { title:"", url:"", poster:"" },

  series: { open:false, seriesId:null, title:"", info:null },
  movie:  { open:false, item:null, url:"", poster:"" },

  player: { open:false, url:"", title:"", poster:"", hls:null }
};

/* ====== PREVIEW COUNTS (LIVE=3) ====== */
const ROW_PREVIEW_COUNT = 14;
const ROW_PREVIEW_BY_KIND = { live: 3, vod: 14, series: 14 };

/* ====== DOM ====== */
const $ = (id)=>document.getElementById(id);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

/* ====== Status ====== */
function setStatus(text, mode="idle"){
  $("statusText").textContent = text;
  const dot = $("statusDot");
  dot.style.background =
    mode==="ok" ? "rgba(60,255,170,.85)" :
    mode==="err"? "rgba(255,72,72,.85)" :
    mode==="load" ? "rgba(255,255,255,.40)" :
    "rgba(255,255,255,.25)";
}

/* ====== Helpers ====== */
function escapeHtml(str=""){
  return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
}
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
  }catch{
    const t=document.createElement("textarea");
    t.value=txt; document.body.appendChild(t);
    t.select(); document.execCommand("copy");
    t.remove();
  }
}
function safeHost(){
  let h = (CONFIG.HOST||"").trim();
  if(!h) return "";
  if(!/^https?:\/\//i.test(h)) h = "https://" + h;
  return h.replace(/\/+$/,"");
}
function apiUrl(params){
  const host = safeHost();
  const qs = new URLSearchParams({ username: CONFIG.USERNAME, password: CONFIG.PASSWORD, ...params });
  return `${host}/player_api.php?${qs.toString()}`;
}
function xmltvUrl(){
  const host = safeHost();
  const qs = new URLSearchParams({ username: CONFIG.USERNAME, password: CONFIG.PASSWORD });
  return `${host}/xmltv.php?${qs.toString()}`;
}
async function fetchJson(url){
  const u = CONFIG.PROXY ? (CONFIG.PROXY + encodeURIComponent(url)) : url;
  const res = await fetch(u, { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* ====== Build playable URLs (Xtream) ====== */
function buildPlayableUrl(kind, item){
  const host = safeHost();
  const u = encodeURIComponent(CONFIG.USERNAME);
  const p = encodeURIComponent(CONFIG.PASSWORD);

  if(kind === "live"){
    const id = item.stream_id || item.id;
    return `${host}/live/${u}/${p}/${id}.m3u8`;
  }

  if(kind === "vod"){
    const id = item.stream_id || item.id;
    const ext = (item.container_extension || "mp4").toLowerCase();
    // many panels use /movie/ for VOD
    return `${host}/movie/${u}/${p}/${id}.${ext}`;
  }

  // series episodes (when item is episode object)
  const id = item.id || item.stream_id;
  const ext = (item.container_extension || "mp4").toLowerCase();
  return `${host}/series/${u}/${p}/${id}.${ext}`;
}

function posterOf(item){
  return item.stream_icon || item.cover || item.movie_image || item.icon || placeholderImg;
}

/* ====== UI Focus (TV remote) ====== */
function tvFocus(el){
  if(!el) return;
  $$(".tvFocus").forEach(x=>x.classList.remove("tvFocus"));
  el.classList.add("tvFocus");
  if(el.focus) el.focus({ preventScroll:true });
  try{ el.scrollIntoView({ block:"nearest", inline:"nearest" }); }catch{}
}

function activeScope(){
  if($("playerModal").style.display !== "none") return $("playerModal");
  if($("searchPanel").style.display !== "none") return $("searchPanel");
  if($("movieDrawer").style.display !== "none") return $("movieDrawer");
  if($("drawer").style.display !== "none") return $("drawer");
  return document;
}

function focusables(scope){
  return $$("[data-focusable='1'], .card, .seeAll", scope)
    .filter(el => el.offsetParent !== null);
}

function moveFocus(dir){
  const scope = activeScope();
  const list = focusables(scope);
  if(!list.length) return;

  const cur = list.findIndex(el => el.classList.contains("tvFocus"));
  const idx = cur >= 0 ? cur : 0;

  // simple directional move: next/prev
  let next = idx;
  if(dir==="next") next = Math.min(list.length-1, idx+1);
  if(dir==="prev") next = Math.max(0, idx-1);
  tvFocus(list[next]);
}

/* ====== Overlays ====== */
function openSearch(){
  $("searchPanel").style.display = "block";
  $("searchResults").innerHTML = "";
  $("searchInput").value = "";
  setStatus("Search", "idle");
  setTimeout(()=>{ $("searchInput").focus(); tvFocus($("searchInput")); }, 50);
}
function closeSearchHard(){
  $("searchPanel").style.display = "none";
}
function drawerIsOpen(){ return $("drawer").style.display !== "none"; }
function closeDrawer(){
  $("drawer").style.display = "none";
  $("drawerTitle").textContent = "Series";
  $("drawerBody").innerHTML = "";
  S.series = { open:false, seriesId:null, title:"", info:null };
}

/* ====== Movie Drawer (NEW) ====== */
function movieDrawerIsOpen(){ return $("movieDrawer").style.display !== "none"; }
function closeMovieDrawer(){
  $("movieDrawer").style.display = "none";
  $("movieTitle").textContent = "Movie";
  $("movieBody").innerHTML = "";
  $("movieOpen").href = "#";
  S.movie = { open:false, item:null, url:"", poster:"" };
}
function openMovieDrawer(item, poster){
  if(!item) return;

  closeSearchHard();
  closeDrawer();

  const url = buildPlayableUrl("vod", item);
  const title = item.name || "Movie";

  S.movie = { open:true, item, url, poster: poster || "" };

  $("movieTitle").textContent = title;
  $("movieOpen").href = url || "#";

  $("movieBody").innerHTML = `
    <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">
      <img src="${poster||placeholderImg}" onerror="this.src='${placeholderImg}'"
           style="width:120px; border-radius:18px; border:1px solid rgba(255,255,255,.12); box-shadow:0 18px 40px rgba(0,0,0,.25);" />
      <div style="min-width:240px;">
        <div style="font-weight:900; color:var(--text); font-size:1.05rem;">${escapeHtml(title)}</div>
        <div style="margin-top:6px;">Format: ${escapeHtml((item.container_extension || "mp4").toUpperCase())}</div>
        <div style="margin-top:6px; word-break:break-all;">${escapeHtml(url||"")}</div>
        <div style="margin-top:10px; font-size:.84rem; color:var(--muted);">
          Click <b>Open</b> or <b>Copy</b> (like Series).
        </div>
      </div>
    </div>
  `;

  $("movieDrawer").style.display = "block";
  setTimeout(()=> tvFocus($("movieOpen")), 60);
}

/* ====== Player ======
   Keep this function signature stable:
   openPlayer(url, title, poster)
*/
function openPlayer(url, title="Playing‚Ä¶", poster=""){
  closeSearchHard();
  closeDrawer();
  closeMovieDrawer();

  $("playerTitle").textContent = title || "Playing‚Ä¶";
  $("playerOpen").href = url || "#";

  $("playerModal").style.display = "block";
  S.player.open = true;
  S.player.url = url;
  S.player.title = title;
  S.player.poster = poster;

  const video = $("video");
  // cleanup old HLS if any
  if(S.player.hls){
    try{ S.player.hls.destroy(); }catch{}
    S.player.hls = null;
  }
  video.pause();
  video.removeAttribute("src");
  video.load();

  if(!url){
    setStatus("No URL to play", "err");
    return;
  }

  setStatus("Loading player‚Ä¶", "load");

  // HLS handling
  if(url.includes(".m3u8")){
    if(video.canPlayType("application/vnd.apple.mpegurl")){
      video.src = url;
      video.play().then(()=>setStatus("Playing", "ok")).catch(()=>setStatus("Tap play", "idle"));
    }else if(window.Hls && Hls.isSupported()){
      const hls = new Hls({ lowLatencyMode:true });
      S.player.hls = hls;
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
        video.play().then(()=>setStatus("Playing", "ok")).catch(()=>setStatus("Tap play", "idle"));
      });
      hls.on(Hls.Events.ERROR, (e,data)=>{
        console.warn("HLS error", data);
        setStatus("Playback error (HLS). Try Open.", "err");
      });
    }else{
      setStatus("HLS not supported in this browser. Use Open.", "err");
    }
    return;
  }

  // mp4 / others
  video.src = url;
  video.play().then(()=>setStatus("Playing", "ok")).catch(()=>setStatus("Tap play", "idle"));
}

function closePlayer(){
  $("playerModal").style.display = "none";
  const video = $("video");
  try{ video.pause(); }catch{}
  if(S.player.hls){
    try{ S.player.hls.destroy(); }catch{}
    S.player.hls = null;
  }
  S.player.open = false;
  setStatus("Closed player", "idle");
}

/* ====== Load data ====== */
async function loadCategories(){
  setStatus("Loading categories‚Ä¶", "load");
  S.cats = [];
  S.itemsByCat.clear();
  S.catNameById.clear();

  const action =
    S.kind==="live" ? "get_live_categories" :
    S.kind==="vod" ? "get_vod_categories" :
    "get_series_categories";

  const url = apiUrl({ action });
  let cats;
  try{
    cats = await fetchJson(url);
  }catch(err){
    console.error(err);
    setStatus("Cannot connect (API). Check HOST/proxy/https.", "err");
    throw err;
  }

  // normalize categories
  S.cats = (cats || []).map(c=>({
    id: String(c.category_id ?? c.id ?? ""),
    name: c.category_name || c.name || "Category"
  })).filter(c=>c.id);

  S.cats.forEach(c=>S.catNameById.set(c.id, c.name));

  setStatus(`Loaded ${S.cats.length} categories`, "ok");
}

async function loadCategoryItems(catId){
  if(S.itemsByCat.has(catId)) return S.itemsByCat.get(catId);

  const action =
    S.kind==="live" ? "get_live_streams" :
    S.kind==="vod" ? "get_vod_streams" :
    "get_series";

  const url = apiUrl({ action, category_id: catId });
  setStatus(`Loading ${S.catNameById.get(catId) || "Category"}‚Ä¶`, "load");

  const items = await fetchJson(url);
  const norm = (items || []).map(it=>({
    ...it,
    name: it.name || it.title || "Untitled"
  }));

  S.itemsByCat.set(catId, norm);
  setStatus(`Loaded ${norm.length} items`, "ok");
  return norm;
}

/* ====== Render ====== */
function setKind(kind){
  S.kind = kind;
  $("kindLabel").textContent = kind === "vod" ? "Movies" : (kind === "series" ? "Series" : "Live");

  $("liveBtn").classList.toggle("active", kind==="live");
  $("moviesBtn").classList.toggle("active", kind==="vod");
  $("seriesBtn").classList.toggle("active", kind==="series");

  // close overlays
  closeSearchHard();
  closeDrawer();
  closeMovieDrawer();
  closePlayer();

  // reset hero
  setHero({
    title: CONFIG.APP_NAME,
    subtitle: kind==="live"
      ? "Pick a category ‚Äî LIVE rows preview only 3 per category."
      : kind==="vod"
      ? "Movies ‚Äî click any movie to Open / Copy (like series)."
      : "Series ‚Äî pick a show, then choose Open / Copy for episodes.",
    poster: placeholderImg,
    backdrop: placeholderImg,
    url: ""
  });

  // load + render
  bootstrap();
}

function setHero({ title, subtitle, poster, backdrop, url }){
  $("heroTitle").textContent = title || CONFIG.APP_NAME;
  $("heroSub").textContent = subtitle || "";
  $("heroPosterImg").src = poster || placeholderImg;
  $("heroPosterImg").onerror = ()=>{ $("heroPosterImg").src = placeholderImg; };
  $("heroMedia").style.backgroundImage = `url('${backdrop || placeholderImg}')`;

  S.hero = { title, url, poster };

  $("heroPlay").disabled = !url;
  $("heroOpen").href = url || "#";
}

function makeCard(item){
  const poster = posterOf(item);
  const card = document.createElement("div");
  card.className = "card";
  card.tabIndex = 0;
  card.setAttribute("data-focusable","1");

  card.innerHTML = `
    <div class="cardPoster"><img src="${poster}" onerror="this.src='${placeholderImg}'" alt=""></div>
    <div class="cardMeta">
      <div class="cardTitle">${escapeHtml(item.name || "Untitled")}</div>
      <div class="cardSub">${escapeHtml(S.kind==="live" ? "Live" : (S.kind==="vod" ? "Movie" : "Series"))}</div>
    </div>
  `;

  card.onclick = ()=>{
    const poster = posterOf(item);

    if(S.kind === "series"){
      openSeries(item, poster);
      return;
    }

    // Movies: open series-style drawer with Open/Copy
    if(S.kind === "vod"){
      openMovieDrawer(item, poster);
      return;
    }

    // Live: play immediately
    const url = buildPlayableUrl("live", item);
    setHero({
      title: item.name || "Live",
      subtitle: "Playing live stream‚Ä¶",
      poster,
      backdrop: poster,
      url
    });
    openPlayer(url, item.name || "Playing‚Ä¶", poster);
  };

  card.onkeydown = (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      card.click();
    }
  };

  return card;
}

async function renderRows(){
  const rows = $("rows");
  rows.innerHTML = "";

  for(const cat of S.cats){
    const sec = document.createElement("div");
    sec.className = "section";

    const head = document.createElement("div");
    head.className = "sectionHead";
    head.innerHTML = `
      <div class="sectionTitle">${escapeHtml(cat.name)}</div>
      <div class="seeAll" tabindex="0" data-focusable="1">See all</div>
    `;

    const row = document.createElement("div");
    row.className = "row";

    // wheel -> horizontal scroll
    row.addEventListener("wheel", (e)=>{
      if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
        row.scrollLeft += e.deltaY;
        e.preventDefault();
      }
    }, { passive:false });

    head.querySelector(".seeAll").onclick = async ()=>{
      const items = await loadCategoryItems(cat.id);
      // render full in a quick modal-style search panel
      openSearch();
      $("searchInput").value = "";
      $("searchResults").innerHTML = `
        <div class="muted" style="padding:6px 2px 12px 2px">
          ${escapeHtml(cat.name)} ‚Äî ${items.length} items
        </div>
      `;
      items.forEach(it=>{
        $("searchResults").appendChild(makeSearchRow(it));
      });
      setTimeout(()=> tvFocus($("searchClose")), 50);
    };

    sec.appendChild(head);
    sec.appendChild(row);
    rows.appendChild(sec);

    // load preview items
    let items = [];
    try{
      items = await loadCategoryItems(cat.id);
    }catch{
      // stop rendering further if API fails
      break;
    }

    const previewCount = ROW_PREVIEW_BY_KIND[S.kind] ?? ROW_PREVIEW_COUNT;
    const preview = items.slice(0, previewCount);

    preview.forEach(it=> row.appendChild(makeCard(it)));
  }

  // Set hero to first item found (without auto-playing)
  const firstCat = S.cats[0];
  if(firstCat){
    const items = S.itemsByCat.get(firstCat.id) || [];
    const first = items[0];
    if(first){
      const poster = posterOf(first);
      const url =
        S.kind==="live" ? buildPlayableUrl("live", first) :
        S.kind==="vod" ? buildPlayableUrl("vod", first) :
        ""; // series needs openSeries
      setHero({
        title: first.name || CONFIG.APP_NAME,
        subtitle: S.kind==="series" ? "Select a series to view episodes." : "Ready",
        poster, backdrop: poster, url
      });
    }
  }
}

/* ====== Series ====== */
async function openSeries(item, poster){
  closeSearchHard();
  closeMovieDrawer();

  const seriesId = item.series_id || item.id;
  if(!seriesId) return;

  $("drawerTitle").textContent = item.name || "Series";
  $("drawerBody").innerHTML = `<div class="muted">Loading episodes‚Ä¶</div>`;
  $("drawer").style.display = "block";
  setTimeout(()=> tvFocus($("drawerClose")), 50);

  setStatus("Loading series info‚Ä¶", "load");

  let info;
  try{
    info = await fetchJson(apiUrl({ action:"get_series_info", series_id: seriesId }));
  }catch(err){
    console.error(err);
    $("drawerBody").innerHTML = `<div class="muted">Failed to load series info.</div>`;
    setStatus("Failed to load series info", "err");
    return;
  }

  S.series = { open:true, seriesId, title: item.name || "Series", info };

  // episodes structure: info.episodes is object keyed by season
  const episodesBySeason = info?.episodes || {};
  const seasons = Object.keys(episodesBySeason).sort((a,b)=>Number(a)-Number(b));

  const body = $("drawerBody");
  body.innerHTML = "";

  if(!seasons.length){
    body.innerHTML = `<div class="muted">No episodes found.</div>`;
    setStatus("No episodes found", "idle");
    return;
  }

  // Simple list all episodes
  seasons.forEach(seasonKey=>{
    const seasonTitle = `Season ${seasonKey}`;
    const h = document.createElement("div");
    h.style.margin = "10px 0 10px 0";
    h.style.fontWeight = "900";
    h.textContent = seasonTitle;
    body.appendChild(h);

    const eps = episodesBySeason[seasonKey] || [];
    eps.forEach(ep=>{
      const epName = ep.title || `Episode ${ep.episode_num || ""}`.trim();
      const url = buildPlayableUrl("series", ep);

      const row = document.createElement("div");
      row.className = "ep";
      row.innerHTML = `
        <div style="min-width:220px;">
          <div class="epName">${escapeHtml(epName)}</div>
          <div class="muted" style="font-size:.8rem">${escapeHtml(url)}</div>
        </div>
        <div class="epBtns">
          <button class="btn primary" data-focusable="1" tabindex="0">Play</button>
          <a class="linkBtn" data-focusable="1" tabindex="0" href="${escapeHtml(url)}" target="_blank" rel="noopener">Open</a>
          <button class="btn" data-focusable="1" tabindex="0">Copy</button>
        </div>
      `;

      const [btnPlay, aOpen, btnCopy] = row.querySelectorAll("button, a");
      btnPlay.onclick = ()=> openPlayer(url, epName, poster || placeholderImg);
      btnCopy.onclick = async ()=>{ await copyText(url); setStatus("Copied", "ok"); };

      body.appendChild(row);
    });
  });

  setStatus("Series loaded", "ok");
}

/* ====== Search ====== */
function makeSearchRow(item){
  const poster = posterOf(item);
  const wrap = document.createElement("div");
  wrap.className = "resultRow";

  const name = document.createElement("div");
  name.innerHTML = `<div class="resultName">${escapeHtml(item.name || "Untitled")}</div>
                    <div class="muted" style="font-size:.8rem">${escapeHtml(S.kind==="live"?"Live":S.kind==="vod"?"Movie":"Series")}</div>`;
  wrap.appendChild(name);

  const btns = document.createElement("div");
  btns.className = "resultBtns";

  // actions vary by kind
  if(S.kind==="series"){
    const openBtn = document.createElement("button");
    openBtn.className = "btn primary";
    openBtn.textContent = "Open";
    openBtn.setAttribute("data-focusable","1");
    openBtn.tabIndex = 0;
    openBtn.onclick = ()=> openSeries(item, poster);

    btns.appendChild(openBtn);
  }else if(S.kind==="vod"){
    const openBtn = document.createElement("button");
    openBtn.className = "btn primary";
    openBtn.textContent = "Open";
    openBtn.setAttribute("data-focusable","1");
    openBtn.tabIndex = 0;
    openBtn.onclick = ()=> openMovieDrawer(item, poster);

    btns.appendChild(openBtn);
  }else{
    const url = buildPlayableUrl("live", item);

    const playBtn = document.createElement("button");
    playBtn.className = "btn primary";
    playBtn.textContent = "Play";
    playBtn.setAttribute("data-focusable","1");
    playBtn.tabIndex = 0;
    playBtn.onclick = ()=> openPlayer(url, item.name || "Playing‚Ä¶", poster);

    const openA = document.createElement("a");
    openA.className = "linkBtn";
    openA.textContent = "Open";
    openA.href = url;
    openA.target = "_blank";
    openA.rel = "noopener";
    openA.setAttribute("data-focusable","1");
    openA.tabIndex = 0;

    const copyBtn = document.createElement("button");
    copyBtn.className = "btn";
    copyBtn.textContent = "Copy";
    copyBtn.setAttribute("data-focusable","1");
    copyBtn.tabIndex = 0;
    copyBtn.onclick = async ()=>{ await copyText(url); setStatus("Copied", "ok"); };

    btns.appendChild(playBtn);
    btns.appendChild(openA);
    btns.appendChild(copyBtn);
  }

  wrap.appendChild(btns);
  return wrap;
}

let searchTimer = null;
async function runSearch(q){
  const out = $("searchResults");
  out.innerHTML = "";

  q = (q||"").trim();
  if(q.length < 2){
    out.innerHTML = `<div class="muted">Type at least 2 characters‚Ä¶</div>`;
    return;
  }

  setStatus("Searching‚Ä¶", "load");

  // Try API-side search (many panels support &search=)
  const action =
    S.kind==="live" ? "get_live_streams" :
    S.kind==="vod" ? "get_vod_streams" :
    "get_series";

  let items = [];
  try{
    items = await fetchJson(apiUrl({ action, search: q }));
  }catch{
    // fallback to local search from cached items
    const all = [];
    for(const [catId, arr] of S.itemsByCat.entries()){
      all.push(...arr);
    }
    items = all.filter(it => (it.name||"").toLowerCase().includes(q.toLowerCase()));
  }

  items = (items||[]).slice(0, 60).map(it=>({ ...it, name: it.name || it.title || "Untitled" }));

  if(!items.length){
    out.innerHTML = `<div class="muted">No results found.</div>`;
    setStatus("No results", "idle");
    return;
  }

  items.forEach(it=> out.appendChild(makeSearchRow(it)));
  setStatus(`Found ${items.length} results`, "ok");

  // focus first actionable
  const first = focusables($("searchPanel"))[0];
  if(first) setTimeout(()=> tvFocus(first), 50);
}

/* ====== Bootstrap ====== */
async function bootstrap(){
  $("rows").innerHTML = "";
  try{
    await loadCategories();
    await renderRows();

    // focus on first visible focusable
    const first = focusables(document)[0];
    if(first) tvFocus(first);
  }catch{
    // keep UI but show error
  }
}

/* ====== Buttons ====== */
$("liveBtn").onclick = ()=> setKind("live");
$("moviesBtn").onclick = ()=> setKind("vod");
$("seriesBtn").onclick = ()=> setKind("series");
$("searchBtn").onclick = ()=> openSearch();
$("reloadBtn").onclick = ()=> bootstrap();

$("searchClose").onclick = ()=> closeSearchHard();
$("drawerClose").onclick = ()=> closeDrawer();

/* Movie drawer buttons */
$("movieClose").onclick = ()=> closeMovieDrawer();
$("moviePlay").onclick = ()=>{
  if(!S.movie?.url) return;
  openPlayer(S.movie.url, (S.movie.item?.name || "Playing‚Ä¶"), (S.movie.poster || ""));
};
$("movieCopy").onclick = async ()=>{
  if(!S.movie?.url) return;
  await copyText(S.movie.url);
  setStatus("Copied", "ok");
};

$("heroPlay").onclick = ()=>{
  if(!S.hero.url) return;
  openPlayer(S.hero.url, S.hero.title, S.hero.poster);
};
$("heroCopy").onclick = async ()=>{
  if(!S.hero.url) return;
  await copyText(S.hero.url);
  setStatus("Copied", "ok");
};

/* Player buttons */
$("playerClose").onclick = ()=> closePlayer();
$("playerCopy").onclick = async ()=>{
  if(!S.player?.url) return;
  await copyText(S.player.url);
  setStatus("Copied", "ok");
};
$("playerFs").onclick = async ()=>{
  const v = $("video");
  try{
    if(document.fullscreenElement) await document.exitFullscreen();
    else await v.requestFullscreen();
  }catch{}
};

/* Search input */
$("searchInput").addEventListener("input", ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> runSearch($("searchInput").value), 220);
});

/* ====== Back / Esc handling ====== */
function handleBack(){
  if($("playerModal").style.display !== "none"){
    closePlayer();
    return true;
  }
  if(movieDrawerIsOpen()){
    closeMovieDrawer();
    return true;
  }
  if(drawerIsOpen()){
    closeDrawer();
    return true;
  }
  if($("searchPanel").style.display !== "none"){
    closeSearchHard();
    return true;
  }
  return false;
}

document.addEventListener("keydown", (e)=>{
  // Back/Escape
  if(e.key === "Escape" || e.key === "Backspace"){
    // avoid backspace navigating browser when not in input
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const isTyping = tag === "input" || tag === "textarea";
    if(!isTyping){
      e.preventDefault();
      if(handleBack()) return;
    }
  }

  // TV remote-like navigation
  if(e.key === "ArrowRight"){ e.preventDefault(); moveFocus("next"); }
  if(e.key === "ArrowLeft"){ e.preventDefault(); moveFocus("prev"); }
  if(e.key === "ArrowDown"){ e.preventDefault(); moveFocus("next"); }
  if(e.key === "ArrowUp"){ e.preventDefault(); moveFocus("prev"); }

  if(e.key === "Enter"){
    const el = document.activeElement;
    if(el && (el.classList.contains("card") || el.classList.contains("seeAll") || el.tagName==="BUTTON" || el.tagName==="A")){
      el.click();
    }
  }
});

/* ====== First run ====== */
(function init(){
  $("heroPosterImg").src = placeholderImg;
  $("heroMedia").style.backgroundImage = `url('${placeholderImg}')`;
  $("heroTitle").textContent = CONFIG.APP_NAME;

  // Quick config check
  if(!safeHost() || CONFIG.USERNAME==="YOUR_USERNAME" || CONFIG.PASSWORD==="YOUR_PASSWORD"){
    setStatus("Set HOST/USERNAME/PASSWORD in CONFIG at top.", "err");
  }else{
    setStatus("Connecting‚Ä¶", "load");
  }

  bootstrap();
})();
</script>
</body>
</html>


